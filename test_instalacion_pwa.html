<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Prueba Instalaci√≥n PWA - Sistema ARCA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ARCA Construcci√≥n">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/icon-32x32.png">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .test-title {
            color: #333;
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 1rem;
        }
        
        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .status-success { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .status-info { color: #17a2b8; }
        
        .test-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 2rem 0;
        }
        
        .info-box {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-box h5 {
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .console-output {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .pwa-install-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .logo-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            position: relative;
        }
        
        .logo-buildings {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 100%;
        }
        
        .building {
            width: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0 2px;
            border-radius: 2px 2px 0 0;
        }
        
        .building-left { height: 60%; }
        .building-center { height: 80%; }
        .building-right { height: 70%; }
        
        .logo-text {
            text-align: center;
            color: #667eea;
            font-weight: bold;
        }
        
        .logo-line-1 { font-size: 0.9rem; }
        .logo-line-2 { font-size: 1.2rem; }
        .logo-line-3 { font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- Logo ARCA -->
        <div class="logo-section">
            <div class="logo-icon">
                <div class="logo-buildings">
                    <div class="building building-left"></div>
                    <div class="building building-center"></div>
                    <div class="building building-right"></div>
                </div>
            </div>
            <div class="logo-text">
                <div class="logo-line-1">SISTEMA</div>
                <div class="logo-line-2">ARCA</div>
                <div class="logo-line-3">CONSTRUCCI√ìN</div>
            </div>
        </div>
        
        <h1 class="test-title">üß™ Prueba de Instalaci√≥n PWA</h1>
        
        <!-- Estado del PWA -->
        <div class="status-card">
            <div class="status-icon status-info">üì±</div>
            <h3>Estado del PWA</h3>
            <p>Verificando si se puede instalar como aplicaci√≥n nativa</p>
            <div id="pwa-status">‚è≥ Verificando...</div>
        </div>
        
        <!-- Informaci√≥n del Sistema -->
        <div class="info-grid">
            <div class="info-box">
                <h5><i class="fas fa-info-circle me-2"></i>Requisitos PWA</h5>
                <ul>
                    <li>‚úÖ Manifest v√°lido</li>
                    <li>‚úÖ Service Worker</li>
                    <li>‚úÖ HTTPS o localhost</li>
                    <li>‚úÖ Iconos apropiados</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h5><i class="fas fa-mobile-alt me-2"></i>Instalaci√≥n M√≥vil</h5>
                <ul>
                    <li><strong>Android:</strong> Chrome ‚Üí Men√∫ ‚Üí Instalar</li>
                    <li><strong>iOS:</strong> Safari ‚Üí Compartir ‚Üí Pantalla Inicio</li>
                    <li><strong>Desktop:</strong> Bot√≥n "Instalar App"</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h5><i class="fas fa-cog me-2"></i>Configuraci√≥n</h5>
                <ul>
                    <li>‚úÖ ALLOWED_HOSTS configurado</li>
                    <li>‚úÖ Servidor en 192.168.0.15:8000</li>
                    <li>‚úÖ PWA meta tags</li>
                    <li>‚úÖ Service Worker registrado</li>
                </ul>
            </div>
        </div>
        
        <!-- Botones de Prueba -->
        <div class="text-center">
            <button class="test-button" onclick="checkPWAStatus()">
                <i class="fas fa-sync-alt me-2"></i>Verificar Estado
            </button>
            <button class="test-button" onclick="testInstallation()">
                <i class="fas fa-download me-2"></i>Probar Instalaci√≥n
            </button>
            <button class="test-button" onclick="clearCache()">
                <i class="fas fa-trash me-2"></i>Limpiar Cache
            </button>
        </div>
        
        <!-- Consola de Pruebas -->
        <div class="console-output" id="console-output">
            <div>üöÄ Iniciando pruebas de instalaci√≥n PWA...</div>
            <div>üì± Verificando compatibilidad del navegador...</div>
        </div>
        
        <!-- Instrucciones -->
        <div class="status-card">
            <h4><i class="fas fa-lightbulb me-2"></i>¬øPor qu√© no aparece el bot√≥n "Instalar App"?</h4>
            <div class="info-grid">
                <div class="info-box">
                    <h6>üîç Criterios de Instalaci√≥n</h6>
                    <ul>
                        <li>Debe ser la primera visita</li>
                        <li>No debe estar ya instalado</li>
                        <li>Debe cumplir criterios PWA</li>
                        <li>Navegador debe soportar PWA</li>
                    </ul>
                </div>
                
                <div class="info-box">
                    <h6>üì± Soluciones</h6>
                    <ul>
                        <li>Limpiar cache del navegador</li>
                        <li>Usar modo inc√≥gnito</li>
                        <li>Verificar que no est√© instalado</li>
                        <li>Esperar unos segundos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bot√≥n de Instalaci√≥n PWA (se mostrar√° autom√°ticamente) -->
    <button id="pwa-install-btn" class="pwa-install-btn" style="display: none;">
        <i class="fas fa-download me-2"></i>üì± Instalar App
    </button>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funci√≥n para agregar mensajes a la consola
        function log(message) {
            const consoleOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // Variables globales para PWA
        let deferredPrompt;
        let pwaInstallBtn;
        
        // Verificar estado del PWA
        function checkPWAStatus() {
            log('üîç Verificando estado del PWA...');
            
            // Verificar Service Worker
            if ('serviceWorker' in navigator) {
                log('‚úÖ Service Worker soportado');
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        log(`‚úÖ Service Worker registrado: ${registrations.length} SW activos`);
                    } else {
                        log('‚ö†Ô∏è No hay Service Workers registrados');
                    }
                });
            } else {
                log('‚ùå Service Worker no soportado');
            }
            
            // Verificar Cache API
            if ('caches' in window) {
                log('‚úÖ Cache API soportado');
                caches.keys().then(cacheNames => {
                    log(`üì¶ Caches encontrados: ${cacheNames.length}`);
                });
            } else {
                log('‚ùå Cache API no soportado');
            }
            
            // Verificar Notificaciones
            if ('Notification' in window) {
                log('‚úÖ Notificaciones soportadas');
                log(`üîî Permisos: ${Notification.permission}`);
            } else {
                log('‚ùå Notificaciones no soportadas');
            }
            
            // Verificar si ya est√° instalado
            if (window.matchMedia('(display-mode: standalone)').matches) {
                log('‚úÖ PWA ya est√° instalada (modo standalone)');
                document.getElementById('pwa-status').innerHTML = '<span class="text-success">‚úÖ Ya instalado</span>';
            } else {
                log('üì± PWA no est√° instalada');
                document.getElementById('pwa-status').innerHTML = '<span class="text-info">üì± No instalado</span>';
            }
            
            // Verificar manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                log('‚úÖ Manifest link encontrado');
                fetch(manifestLink.href)
                    .then(response => response.json())
                    .then(manifest => {
                        log(`üìã Manifest v√°lido: ${manifest.name}`);
                    })
                    .catch(error => {
                        log(`‚ùå Error en manifest: ${error.message}`);
                    });
            } else {
                log('‚ùå No se encontr√≥ link al manifest');
            }
        }
        
        // Probar instalaci√≥n
        function testInstallation() {
            log('üß™ Probando instalaci√≥n PWA...');
            
            if (deferredPrompt) {
                log('üöÄ Prompt de instalaci√≥n disponible');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        log('‚úÖ Usuario acept√≥ instalar la PWA');
                    } else {
                        log('‚ùå Usuario rechaz√≥ instalar la PWA');
                    }
                    deferredPrompt = null;
                });
            } else {
                log('‚ö†Ô∏è No hay prompt de instalaci√≥n disponible');
                log('üí° Intenta limpiar el cache o usar modo inc√≥gnito');
            }
        }
        
        // Limpiar cache
        function clearCache() {
            log('üóëÔ∏è Limpiando cache...');
            
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => {
                            log(`üóëÔ∏è Eliminando cache: ${cacheName}`);
                            return caches.delete(cacheName);
                        })
                    );
                }).then(() => {
                    log('‚úÖ Cache limpiado completamente');
                    log('üîÑ Recarga la p√°gina para probar la instalaci√≥n');
                });
            }
            
            // Limpiar cache del Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                        log('üîÑ Service Worker desregistrado');
                    });
                });
            }
        }
        
        // Eventos PWA
        window.addEventListener('beforeinstallprompt', function(e) {
            log('üöÄ Evento beforeinstallprompt detectado');
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar bot√≥n de instalaci√≥n
            showInstallButton();
        });
        
        window.addEventListener('appinstalled', function(e) {
            log('‚úÖ PWA instalada exitosamente');
            deferredPrompt = null;
            hideInstallButton();
            document.getElementById('pwa-status').innerHTML = '<span class="text-success">‚úÖ Instalado exitosamente</span>';
        });
        
        // Mostrar bot√≥n de instalaci√≥n
        function showInstallButton() {
            log('üì± Mostrando bot√≥n de instalaci√≥n PWA');
            pwaInstallBtn = document.getElementById('pwa-install-btn');
            pwaInstallBtn.style.display = 'block';
            
            pwaInstallBtn.addEventListener('click', function() {
                log('üîÑ Usuario hizo clic en instalar PWA');
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(function(choiceResult) {
                        if (choiceResult.outcome === 'accepted') {
                            log('‚úÖ Usuario acept√≥ instalar la PWA');
                        } else {
                            log('‚ùå Usuario rechaz√≥ instalar la PWA');
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
        
        // Ocultar bot√≥n de instalaci√≥n
        function hideInstallButton() {
            const pwaInstallBtn = document.getElementById('pwa-install-btn');
            if (pwaInstallBtn) {
                pwaInstallBtn.style.display = 'none';
            }
        }
        
        // Verificaciones autom√°ticas al cargar
        window.addEventListener('load', function() {
            log('üöÄ P√°gina cargada, iniciando verificaciones...');
            
            setTimeout(() => {
                checkPWAStatus();
            }, 1000);
        });
        
        log('üß™ Sistema de pruebas de instalaci√≥n PWA iniciado');
    </script>
</body>
</html>
