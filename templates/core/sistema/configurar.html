{% extends 'base.html' %}

{% block title %}Configuración del Sistema - Sistema de Construcción{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para notificaciones modernas */
    .modern-notification {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        margin-bottom: 16px;
        overflow: hidden;
        position: relative;
        transform: translateX(100%);
        opacity: 0;
        animation: slideInRight 0.5s ease forwards;
        border-left: 4px solid;
    }
    
    .modern-notification.alert-success {
        border-left-color: #28a745;
    }
    
    .modern-notification.alert-error {
        border-left-color: #dc3545;
    }
    
    .modern-notification.alert-warning {
        border-left-color: #ffc107;
    }
    
    .modern-notification.alert-info {
        border-left-color: #17a2b8;
    }
    
    .notification-content {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        position: relative;
    }
    
    .notification-icon {
        margin-right: 12px;
        font-size: 20px;
        margin-top: 2px;
    }
    
    .modern-notification.alert-success .notification-icon {
        color: #28a745;
    }
    
    .modern-notification.alert-error .notification-icon {
        color: #dc3545;
    }
    
    .modern-notification.alert-warning .notification-icon {
        color: #ffc107;
    }
    
    .modern-notification.alert-info .notification-icon {
        color: #17a2b8;
    }
    
    .notification-text {
        flex: 1;
        font-size: 14px;
        line-height: 1.4;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Estilos para modals de confirmación */
    .modal-header.bg-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    
    .modal-header.bg-warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        border-radius: 15px 15px 0 0;
        border-bottom: none;
    }
    
    .modal-footer {
        border-radius: 0 0 15px 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
    }
    
    .btn-secondary {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="fas fa-cog me-2"></i>Configuración del Sistema
    </h2>
    <a href="{% url 'sistema' %}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-2"></i>Volver al Sistema
    </a>
</div>

<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>Configuración General
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Información de la Empresa -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-building me-2"></i>Información de la Empresa
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="nombre_empresa" class="form-label">
                                <i class="fas fa-building me-1"></i>Nombre de la Empresa
                            </label>
                            <input type="text" class="form-control" id="nombre_empresa" name="nombre_empresa" 
                                   value="{{ config.nombre_empresa|default:'Constructora XYZ' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="moneda" class="form-label">
                                <i class="fas fa-dollar-sign me-1"></i>Moneda Principal
                            </label>
                            <select class="form-select" id="moneda" name="moneda">
                                <option value="GTQ" {% if config.moneda == 'GTQ' %}selected{% endif %}>Quetzal (GTQ)</option>
                                <option value="USD" {% if config.moneda == 'USD' %}selected{% endif %}>Dólar (USD)</option>
                                <option value="EUR" {% if config.moneda == 'EUR' %}selected{% endif %}>Euro (EUR)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Configuración Regional -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-globe me-2"></i>Configuración Regional
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="zona_horaria" class="form-label">
                                <i class="fas fa-clock me-1"></i>Zona Horaria
                            </label>
                            <select class="form-select" id="zona_horaria" name="zona_horaria">
                                <option value="America/Guatemala" {% if config.zona_horaria == 'America/Guatemala' %}selected{% endif %}>Guatemala (GMT-6)</option>
                                <option value="America/New_York" {% if config.zona_horaria == 'America/New_York' %}selected{% endif %}>Nueva York (GMT-5)</option>
                                <option value="Europe/Madrid" {% if config.zona_horaria == 'Europe/Madrid' %}selected{% endif %}>Madrid (GMT+1)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="idioma" class="form-label">
                                <i class="fas fa-language me-1"></i>Idioma
                            </label>
                            <select class="form-select" id="idioma" name="idioma">
                                <option value="es" {% if config.idioma == 'es' %}selected{% endif %}>Español</option>
                                <option value="en" {% if config.idioma == 'en' %}selected{% endif %}>English</option>
                            </select>
                        </div>
                    </div>

                    <!-- Configuración del Sistema -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-server me-2"></i>Configuración del Sistema
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="max_usuarios_simultaneos" class="form-label">
                                <i class="fas fa-users me-1"></i>Máximo Usuarios Simultáneos
                            </label>
                            <input type="number" class="form-control" id="max_usuarios_simultaneos" 
                                   name="max_usuarios_simultaneos" value="{{ config.max_usuarios_simultaneos|default:5 }}" 
                                   min="1" max="100">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tiempo_sesion" class="form-label">
                                <i class="fas fa-hourglass me-1"></i>Tiempo de Sesión (minutos)
                            </label>
                            <input type="number" class="form-control" id="tiempo_sesion" name="tiempo_sesion" 
                                   value="{{ config.tiempo_sesion|default:480 }}" min="15" max="1440">
                        </div>
                    </div>

                    <!-- Configuraciones Avanzadas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-cogs me-2"></i>Configuraciones Avanzadas
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="respaldo_automatico" 
                                       name="respaldo_automatico" {% if config.respaldo_automatico %}checked{% endif %}>
                                <label class="form-check-label" for="respaldo_automatico">
                                    <i class="fas fa-database me-1"></i>Respaldo Automático
                                </label>
                                <small class="form-text text-muted d-block">Habilitar respaldo automático diario</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notificaciones_email" 
                                       name="notificaciones_email" {% if config.notificaciones_email %}checked{% endif %}>
                                <label class="form-check-label" for="notificaciones_email">
                                    <i class="fas fa-envelope me-1"></i>Notificaciones por Email
                                </label>
                                <small class="form-text text-muted d-block">Enviar notificaciones por email</small>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Email -->
                    <div class="row mb-4" id="email-config" {% if not config.notificaciones_email %}style="display: none;"{% endif %}>
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-envelope me-2"></i>Configuración de Email
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email_host" class="form-label">
                                <i class="fas fa-server me-1"></i>Servidor SMTP
                            </label>
                            <input type="text" class="form-control" id="email_host" name="email_host" 
                                   value="{{ config.email_host }}" placeholder="smtp.gmail.com">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email_port" class="form-label">
                                <i class="fas fa-plug me-1"></i>Puerto
                            </label>
                            <input type="number" class="form-control" id="email_port" name="email_port" 
                                   value="{{ config.email_port }}" min="1" max="65535">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email_username" class="form-label">
                                <i class="fas fa-user me-1"></i>Usuario
                            </label>
                            <input type="email" class="form-control" id="email_username" name="email_username" 
                                   value="{{ config.email_username }}" placeholder="usuario@empresa.com">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>Contraseña
                            </label>
                            <input type="password" class="form-control" id="email_password" name="email_password" 
                                   value="{{ config.email_password }}" placeholder="Contraseña de aplicación">
                        </div>
                        <div class="col-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="email_use_tls" 
                                       name="email_use_tls" {% if config.email_use_tls %}checked{% endif %}>
                                <label class="form-check-label" for="email_use_tls">
                                    <i class="fas fa-shield-alt me-1"></i>Usar TLS
                                </label>
                                <small class="form-text text-muted d-block">Recomendado para Gmail y otros proveedores</small>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="restaurarValores()">
                            <i class="fas fa-undo me-1"></i>Restaurar Valores
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Guardar Configuración
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Información del Sistema
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="text-center">
                            <h6 class="text-muted">Versión Django</h6>
                            <p class="h5">5.2.5</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h6 class="text-muted">Python</h6>
                            <p class="h5">3.13.6</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-center mb-3">
                    <h6 class="text-muted">Estado del Sistema</h6>
                    <span class="badge bg-success fs-6">Operativo</span>
                </div>
                <hr>
                <div class="text-center">
                    <h6 class="text-muted">Última Configuración</h6>
                    <p class="text-muted">{{ config.ultima_actualizacion|default:"Nunca" }}</p>
                </div>
            </div>
        </div>

        <!-- Herramientas del Sistema -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Herramientas del Sistema
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="confirmarRespaldo()">
                        <i class="fas fa-download me-2"></i>Crear Respaldo
                    </button>
                    <a href="{% url 'sistema_ver_respaldos' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-folder-open me-2"></i>Ver Respaldos
                    </a>
                    <button type="button" class="btn btn-outline-success" onclick="restaurarRespaldo()">
                        <i class="fas fa-upload me-2"></i>Restaurar Respaldo
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="confirmarLimpiarLogs()">
                        <i class="fas fa-broom me-2"></i>Limpiar Logs Antiguos
                    </button>
                    <a href="{% url 'sistema_exportar_config' %}" class="btn btn-outline-info">
                        <i class="fas fa-file-export me-2"></i>Exportar Configuración
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar/ocultar configuración de email según el checkbox
    const emailCheckbox = document.getElementById('notificaciones_email');
    const emailConfig = document.getElementById('email-config');
    
    emailCheckbox.addEventListener('change', function() {
        if (this.checked) {
            emailConfig.style.display = 'block';
        } else {
            emailConfig.style.display = 'none';
        }
    });
});

function restaurarValores() {
    const modal = new bootstrap.Modal(document.getElementById('confirmarRestaurarModal'));
    modal.show();
}

function confirmarRespaldo() {
    const modal = new bootstrap.Modal(document.getElementById('confirmarRespaldoModal'));
    modal.show();
}

function confirmarLimpiarLogs() {
    const modal = new bootstrap.Modal(document.getElementById('confirmarLimpiarLogsModal'));
    modal.show();
}

function ejecutarRestaurarValores() {
    // Restaurar valores por defecto
    document.getElementById('nombre_empresa').value = 'Constructora XYZ';
    document.getElementById('moneda').value = 'GTQ';
    document.getElementById('zona_horaria').value = 'America/Guatemala';
    document.getElementById('idioma').value = 'es';
    document.getElementById('max_usuarios_simultaneos').value = '5';
    document.getElementById('tiempo_sesion').value = '480';
    document.getElementById('respaldo_automatico').checked = false;
    document.getElementById('notificaciones_email').checked = false;
    document.getElementById('email_host').value = '';
    document.getElementById('email_port').value = '587';
    document.getElementById('email_username').value = '';
    document.getElementById('email_password').value = '';
    document.getElementById('email_use_tls').checked = true;
    
    // Ocultar configuración de email
    document.getElementById('email-config').style.display = 'none';
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmarRestaurarModal'));
    modal.hide();
    
    // Mostrar notificación de éxito
    showSuccessNotification('✅ Valores restaurados a los valores por defecto');
}

function ejecutarCrearRespaldo() {
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmarRespaldoModal'));
    modal.hide();
    
    // Redirigir a la URL de crear respaldo
    window.location.href = "{% url 'sistema_crear_respaldo' %}";
}

function ejecutarLimpiarLogs() {
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmarLimpiarLogsModal'));
    modal.hide();
    
    // Redirigir a la URL de limpiar logs
    window.location.href = "{% url 'sistema_limpiar_logs' %}";
}

function showSuccessNotification(message) {
    // Crear notificación toast moderna
    const notification = document.createElement('div');
    notification.className = 'modern-notification alert-success';
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-text">
                <strong>Éxito</strong><br>
                ${message}
            </div>
        </div>
    `;
    
    // Agregar al contenedor de notificaciones
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            width: 100%;
        `;
        document.body.appendChild(container);
    }
    
    container.appendChild(notification);
    
    // Remover después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function restaurarRespaldo() {
    alert('⚠️ Función de restauración de respaldo en desarrollo.\n\nPor ahora, puedes restaurar manualmente usando:\npython manage.py loaddata respaldo_sistema_YYYYMMDD_HHMMSS.json');
}
</script>

<!-- Modal de Confirmación de Respaldo -->
<div class="modal fade" id="confirmarRespaldoModal" tabindex="-1" aria-labelledby="confirmarRespaldoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmarRespaldoModalLabel">
                    <i class="fas fa-database me-2"></i>Confirmar Respaldo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3">
                        <i class="fas fa-download fa-3x text-primary"></i>
                    </div>
                    <h6 class="mb-3">¿Crear respaldo de la base de datos?</h6>
                    <div class="alert alert-info">
                        <strong>ℹ️ Información:</strong> Se creará un respaldo completo de la base de datos del sistema.
                        <br><br>
                        <div class="row">
                            <div class="col-6">
                                <strong>Incluye:</strong><br>
                                <span>• Todos los datos</span><br>
                                <span>• Configuraciones</span><br>
                                <span>• Archivos adjuntos</span>
                            </div>
                            <div class="col-6">
                                <strong>Tiempo estimado:</strong><br>
                                <span class="text-primary fw-bold">1-3 minutos</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="ejecutarCrearRespaldo()">
                    <i class="fas fa-download me-2"></i>Crear Respaldo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Restaurar Valores -->
<div class="modal fade" id="confirmarRestaurarModal" tabindex="-1" aria-labelledby="confirmarRestaurarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="confirmarRestaurarModalLabel">
                    <i class="fas fa-undo me-2"></i>Confirmar Restauración
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3">
                        <i class="fas fa-undo fa-3x text-warning"></i>
                    </div>
                    <h6 class="mb-3">¿Estás seguro de que quieres restaurar los valores por defecto?</h6>
                    <div class="alert alert-warning">
                        <strong>⚠️ Advertencia:</strong> Esta acción restaurará todos los valores de configuración a sus valores por defecto.
                        <br><br>
                        <div class="row">
                            <div class="col-6">
                                <strong>Se restaurará:</strong><br>
                                <span>• Nombre de empresa</span><br>
                                <span>• Configuración regional</span><br>
                                <span>• Configuración del sistema</span>
                            </div>
                            <div class="col-6">
                                <strong>Se perderá:</strong><br>
                                <span>• Configuración de email</span><br>
                                <span>• Configuraciones personalizadas</span><br>
                                <span>• Preferencias guardadas</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="ejecutarRestaurarValores()">
                    <i class="fas fa-undo me-2"></i>Restaurar Valores
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Limpiar Logs -->
<div class="modal fade" id="confirmarLimpiarLogsModal" tabindex="-1" aria-labelledby="confirmarLimpiarLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="confirmarLimpiarLogsModalLabel">
                    <i class="fas fa-broom me-2"></i>Confirmar Limpieza
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3">
                        <i class="fas fa-broom fa-3x text-warning"></i>
                    </div>
                    <h6 class="mb-3">¿Limpiar logs antiguos (más de 30 días)?</h6>
                    <div class="alert alert-warning">
                        <strong>⚠️ Advertencia:</strong> Se eliminarán todos los logs del sistema que tengan más de 30 días de antigüedad.
                        <br><br>
                        <div class="row">
                            <div class="col-6">
                                <strong>Se eliminará:</strong><br>
                                <span>• Logs de errores antiguos</span><br>
                                <span>• Logs de acceso antiguos</span><br>
                                <span>• Archivos de log grandes</span>
                            </div>
                            <div class="col-6">
                                <strong>Se conservará:</strong><br>
                                <span>• Logs recientes (30 días)</span><br>
                                <span>• Logs de errores críticos</span><br>
                                <span>• Logs de auditoría</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="ejecutarLimpiarLogs()">
                    <i class="fas fa-broom me-2"></i>Limpiar Logs
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
