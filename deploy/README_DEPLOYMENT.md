# üöÄ Gu√≠a de Despliegue para Producci√≥n - Sistema de Construcci√≥n

## üìã Tabla de Contenidos

1. [Requisitos del Sistema](#requisitos-del-sistema)
2. [Preparaci√≥n del Servidor](#preparaci√≥n-del-servidor)
3. [Instalaci√≥n de Dependencias](#instalaci√≥n-de-dependencias)
4. [Configuraci√≥n del Proyecto](#configuraci√≥n-del-proyecto)
5. [Despliegue Autom√°tico](#despliegue-autom√°tico)
6. [Configuraci√≥n Manual](#configuraci√≥n-manual)
7. [Verificaci√≥n del Despliegue](#verificaci√≥n-del-despliegue)
8. [Mantenimiento](#mantenimiento)
9. [Soluci√≥n de Problemas](#soluci√≥n-de-problemas)
10. [Seguridad](#seguridad)

## üñ•Ô∏è Requisitos del Sistema

### Requisitos M√≠nimos
- **Sistema Operativo**: Ubuntu 20.04 LTS o superior
- **RAM**: 2 GB m√≠nimo, 4 GB recomendado
- **Almacenamiento**: 20 GB m√≠nimo, 50 GB recomendado
- **CPU**: 2 cores m√≠nimo, 4 cores recomendado

### Requisitos de Software
- **Python**: 3.8 o superior
- **PostgreSQL**: 12 o superior (recomendado para producci√≥n)
- **Redis**: 6.0 o superior (opcional para cach√©)
- **Nginx**: 1.18 o superior
- **Supervisor**: 4.0 o superior

## üõ†Ô∏è Preparaci√≥n del Servidor

### 1. Actualizar el Sistema
```bash
sudo apt update && sudo apt upgrade -y
sudo apt autoremove -y
```

### 2. Instalar Paquetes B√°sicos
```bash
sudo apt install -y \
    curl \
    wget \
    git \
    unzip \
    htop \
    vim \
    nano \
    ufw \
    fail2ban \
    logrotate \
    cron \
    rsyslog
```

### 3. Configurar Zona Horaria
```bash
sudo timedatectl set-timezone America/Argentina/Buenos_Aires
```

### 4. Crear Usuario del Sistema
```bash
sudo adduser --system --group --home /var/www/sistema_construccion www-data
sudo usermod -aG sudo www-data
```

## üì¶ Instalaci√≥n de Dependencias

### 1. Instalar Python y pip
```bash
sudo apt install -y python3 python3-pip python3-venv python3-dev
sudo apt install -y build-essential libssl-dev libffi-dev
```

### 2. Instalar PostgreSQL
```bash
sudo apt install -y postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql

# Crear base de datos y usuario
sudo -u postgres psql -c "CREATE DATABASE sistema_construccion_prod;"
sudo -u postgres psql -c "CREATE USER sistema_user WITH PASSWORD 'tu_password_seguro';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE sistema_construccion_prod TO sistema_user;"
sudo -u postgres psql -c "ALTER USER sistema_user CREATEDB;"
```

### 3. Instalar Redis (Opcional)
```bash
sudo apt install -y redis-server
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

### 4. Instalar Nginx
```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 5. Instalar Supervisor
```bash
sudo apt install -y supervisor
sudo systemctl start supervisor
sudo systemctl enable supervisor
```

### 6. Instalar Certbot (SSL)
```bash
sudo apt install -y certbot python3-certbot-nginx
```

## ‚öôÔ∏è Configuraci√≥n del Proyecto

### 1. Clonar el Proyecto
```bash
cd /var/www
sudo git clone https://github.com/tu-usuario/sistema-construccion-django.git sistema_construccion
sudo chown -R www-data:www-data sistema_construccion
```

### 2. Crear Entorno Virtual
```bash
cd sistema_construccion
sudo -u www-data python3 -m venv venv
sudo -u www-data venv/bin/pip install --upgrade pip
sudo -u www-data venv/bin/pip install -r requirements.txt
```

### 3. Configurar Variables de Entorno
```bash
sudo -u www-data cp env_example.txt .env
sudo -u www-data nano .env
```

**Configuraci√≥n m√≠nima del .env:**
```env
ENVIRONMENT=production
DEBUG=False
SECRET_KEY=tu_clave_secreta_muy_larga_y_compleja
DATABASE_URL=postgresql://sistema_user:tu_password_seguro@localhost/sistema_construccion_prod
REDIS_URL=redis://localhost:6379/1
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=tu_email@gmail.com
EMAIL_HOST_PASSWORD=tu_password_de_aplicacion
```

### 4. Aplicar Migraciones
```bash
sudo -u www-data venv/bin/python manage.py migrate --settings=sistema_construccion.production_settings
```

### 5. Crear Superusuario
```bash
sudo -u www-data venv/bin/python manage.py createsuperuser --settings=sistema_construccion.production_settings
```

### 6. Recolectar Archivos Est√°ticos
```bash
sudo -u www-data venv/bin/python manage.py collectstatic --settings=sistema_construccion.production_settings --noinput
```

## üöÄ Despliegue Autom√°tico

### 1. Ejecutar Script de Despliegue
```bash
cd /var/www/sistema_construccion/deploy
sudo chmod +x deploy_production.sh
sudo ./deploy_production.sh
```

### 2. El Script Automatiza:
- ‚úÖ Verificaci√≥n de dependencias
- ‚úÖ Creaci√≥n de directorios
- ‚úÖ Configuraci√≥n de permisos
- ‚úÖ Configuraci√≥n de Nginx
- ‚úÖ Configuraci√≥n de Supervisor
- ‚úÖ Configuraci√≥n de SSL (opcional)
- ‚úÖ Configuraci√≥n de firewall
- ‚úÖ Configuraci√≥n de respaldos autom√°ticos
- ‚úÖ Configuraci√≥n de monitoreo
- ‚úÖ Verificaci√≥n del despliegue

## üîß Configuraci√≥n Manual

### 1. Configurar Nginx
```bash
sudo cp /var/www/sistema_construccion/nginx/sistema_construccion.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/sistema_construccion /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 2. Configurar Supervisor
```bash
sudo cp /var/www/sistema_construccion/supervisor/sistema_construccion.conf /etc/supervisor/conf.d/
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start sistema_construccion_group:*
```

### 3. Configurar SSL con Let's Encrypt
```bash
sudo certbot --nginx -d tu-dominio.com
sudo crontab -e
# Agregar: 0 12 * * * /usr/bin/certbot renew --quiet
```

## ‚úÖ Verificaci√≥n del Despliegue

### 1. Verificar Servicios
```bash
# Verificar Nginx
sudo systemctl status nginx

# Verificar Supervisor
sudo systemctl status supervisor

# Verificar PostgreSQL
sudo systemctl status postgresql

# Verificar Redis (si est√° instalado)
sudo systemctl status redis-server
```

### 2. Verificar Aplicaci√≥n
```bash
# Verificar endpoint de salud
curl http://localhost/health/

# Verificar logs
sudo tail -f /var/log/supervisor/sistema_construccion_stdout.log
sudo tail -f /var/www/sistema_construccion/logs/django/django.log
```

### 3. Verificar Archivos Est√°ticos
```bash
# Verificar que los archivos est√°ticos est√©n disponibles
ls -la /var/www/sistema_construccion/staticfiles/
curl http://localhost/static/admin/css/base.css
```

## üîÑ Mantenimiento

### 1. Respaldos Autom√°ticos
Los respaldos se ejecutan autom√°ticamente cada 6 horas:
```bash
# Ver respaldos
ls -la /var/www/sistema_construccion/backups/auto/

# Crear respaldo manual
sudo -u www-data /var/www/sistema_construccion/backup_script.sh
```

### 2. Monitoreo del Sistema
El monitoreo se ejecuta cada 15 minutos:
```bash
# Ver script de monitoreo
cat /var/www/sistema_construccion/monitor_script.sh

# Ejecutar monitoreo manual
sudo -u www-data /var/www/sistema_construccion/monitor_script.sh
```

### 3. Actualizaciones
```bash
# Actualizar c√≥digo
cd /var/www/sistema_construccion
sudo -u www-data git pull origin main

# Instalar nuevas dependencias
sudo -u www-data venv/bin/pip install -r requirements.txt

# Aplicar migraciones
sudo -u www-data venv/bin/python manage.py migrate --settings=sistema_construccion.production_settings

# Recolectar archivos est√°ticos
sudo -u www-data venv/bin/python manage.py collectstatic --settings=sistema_construccion.production_settings --noinput

# Reiniciar aplicaci√≥n
sudo supervisorctl restart sistema_construccion
```

### 4. Logs del Sistema
```bash
# Logs de Django
sudo tail -f /var/www/sistema_construccion/logs/django/django.log

# Logs de Gunicorn
sudo tail -f /var/www/sistema_construccion/logs/gunicorn/gunicorn_error.log

# Logs de Nginx
sudo tail -f /var/log/nginx/error.log

# Logs de Supervisor
sudo tail -f /var/log/supervisor/sistema_construccion_stdout.log
```

## üö® Soluci√≥n de Problemas

### 1. Problemas Comunes

#### La aplicaci√≥n no responde
```bash
# Verificar estado de Supervisor
sudo supervisorctl status

# Verificar logs de Gunicorn
sudo tail -f /var/www/sistema_construccion/logs/gunicorn/gunicorn_error.log

# Reiniciar aplicaci√≥n
sudo supervisorctl restart sistema_construccion
```

#### Error 502 Bad Gateway
```bash
# Verificar que Gunicorn est√© funcionando
sudo supervisorctl status sistema_construccion

# Verificar puerto 8000
sudo netstat -tlnp | grep :8000

# Verificar logs de Nginx
sudo tail -f /var/log/nginx/error.log
```

#### Problemas de permisos
```bash
# Corregir permisos
sudo chown -R www-data:www-data /var/www/sistema_construccion
sudo chmod -R 755 /var/www/sistema_construccion
sudo chmod -R 750 /var/www/sistema_construccion/logs
sudo chmod -R 750 /var/www/sistema_construccion/backups
```

### 2. Comandos de Diagn√≥stico
```bash
# Verificar estado de todos los servicios
sudo systemctl status nginx postgresql supervisor

# Verificar uso de recursos
htop
df -h
free -h

# Verificar conexiones de red
sudo netstat -tlnp
sudo ss -tlnp

# Verificar logs del sistema
sudo journalctl -u nginx -f
sudo journalctl -u supervisor -f
```

## üîí Seguridad

### 1. Firewall
```bash
# Verificar estado del firewall
sudo ufw status

# Configurar reglas adicionales si es necesario
sudo ufw allow from tu_ip_administrativa to any port 22
sudo ufw deny 22  # Bloquear SSH para todos excepto tu IP
```

### 2. Fail2ban
```bash
# Verificar estado de Fail2ban
sudo systemctl status fail2ban

# Ver logs de Fail2ban
sudo tail -f /var/log/fail2ban.log
```

### 3. Auditor√≠a de Seguridad
```bash
# Verificar logs de seguridad
sudo tail -f /var/www/sistema_construccion/logs/django/django.log | grep -i "security\|auth\|login"

# Verificar intentos de acceso fallidos
sudo grep "Failed password" /var/log/auth.log
```

## üìä Monitoreo y M√©tricas

### 1. M√©tricas del Sistema
- **CPU**: Monitoreado cada 15 minutos
- **Memoria**: Monitoreado cada 15 minutos
- **Disco**: Monitoreado cada 15 minutos
- **Logs de Error**: Monitoreado cada 15 minutos

### 2. Alertas Autom√°ticas
- **Email**: Enviado cuando se superan los umbrales
- **Logs**: Registrados en `/var/www/sistema_construccion/logs/`
- **Supervisor**: Monitoreo autom√°tico de procesos

### 3. Dashboard de Monitoreo
Acceder a `/health/` para ver el estado del sistema:
```bash
curl http://localhost/health/
curl http://localhost/health/database/
```

## üîß Comandos √ötiles

### Gesti√≥n de la Aplicaci√≥n
```bash
# Reiniciar aplicaci√≥n
sudo supervisorctl restart sistema_construccion

# Ver estado de todos los procesos
sudo supervisorctl status

# Ver logs en tiempo real
sudo supervisorctl tail sistema_construccion

# Parar aplicaci√≥n
sudo supervisorctl stop sistema_construccion

# Iniciar aplicaci√≥n
sudo supervisorctl start sistema_construccion
```

### Gesti√≥n de Nginx
```bash
# Verificar configuraci√≥n
sudo nginx -t

# Recargar configuraci√≥n
sudo nginx -s reload

# Reiniciar Nginx
sudo systemctl restart nginx

# Ver logs en tiempo real
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### Gesti√≥n de Base de Datos
```bash
# Conectar a PostgreSQL
sudo -u postgres psql -d sistema_construccion_prod

# Crear respaldo
sudo -u postgres pg_dump sistema_construccion_prod > backup.sql

# Restaurar respaldo
sudo -u postgres psql -d sistema_construccion_prod < backup.sql
```

## üìû Soporte

### Informaci√≥n de Contacto
- **Email**: soporte@tu-empresa.com
- **Documentaci√≥n**: [URL de la documentaci√≥n]
- **Issues**: [URL del repositorio de issues]

### Informaci√≥n del Sistema
- **Versi√≥n**: 1.0.0
- **√öltima Actualizaci√≥n**: $(date)
- **Soporte**: Django 5.2+, Python 3.8+

---

## üéØ Pr√≥ximos Pasos

1. **Configurar dominio personalizado**
2. **Configurar certificado SSL**
3. **Configurar respaldos externos**
4. **Configurar monitoreo avanzado**
5. **Configurar CI/CD**
6. **Configurar balanceo de carga**

---

**¬°El sistema est√° listo para producci√≥n! üöÄ**

Para cualquier consulta o problema, revisa los logs y utiliza los comandos de diagn√≥stico proporcionados en esta gu√≠a.



